æœ¬æ–‡æ˜¯ **åŸºäº Geth v1.13.15 çš„ Engine æ¥å£ï¼ˆæœªåˆ† EL/CLï¼ŒPoA ä»åœ¨å…±è¯†å±‚ï¼‰** çš„å®Œæ•´è®²è§£ã€‚


---

#  **ç¬¬ä¸€ç¯‡ï¼šEngine è®¾è®¡ç†å¿µä¸èŒè´£è¾¹ç•Œ**

åœ¨ v1.13.15 ä¸­ï¼Œä»¥å¤ªåŠå®¢æˆ·ç«¯ä»ç„¶æ˜¯ â€œ**æ‰§è¡Œå±‚ + å…±è¯†å±‚åˆä¸€**â€ï¼ˆä¸ The Merge åä¸åŒï¼‰ã€‚

**Engine æ¥å£æ˜¯æ•´ä¸ªå…±è¯†æ¨¡å—çš„æ€»å…¥å£**ï¼ŒMinerï¼ˆæŒ–çŸ¿æ¨¡å—ï¼‰åªæœ‰é€šè¿‡ Engine æ‰èƒ½æ„é€ ä¸éªŒè¯åŒºå—ã€‚

ä¸‹å›¾æ˜¯ v1.13.15 çš„çŸ¿å·¥ä¸ Engine çš„å…³ç³»ï¼š

```
TxPool â†’ Miner â†’ Engine â†’ Block â†’ Chain
                    â†‘
                Clique / Aura / IBFT
```

åœ¨ PoAï¼ˆCliqueã€Auraæˆ– IBFTï¼‰é‡Œæ²¡æœ‰ PoWï¼Œä¹Ÿæ²¡æœ‰ Beacon/Validator Set splitï¼Œ
æ‰€æœ‰é€»è¾‘éƒ½åœ¨ Engine ä¸­å®Œæˆï¼š

* éªŒè¯è€…èº«ä»½ç®¡ç†
* ç­¾åéªŒè¯
* difficulty/extraData çš„ç”Ÿæˆ
* å‡ºå—é—´éš”ï¼ˆslotï¼‰è§„åˆ™
* Seal é˜¶æ®µæ‰§è¡Œç­¾å
* Finalize é˜¶æ®µå‘æ”¾å¥–åŠ±æˆ–æ‰§è¡Œç³»ç»Ÿåˆçº¦ï¼ˆä¾‹å¦‚ Clique ä¸å‘å¥–åŠ±ï¼‰

Engine å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªâ€œ**å…±è¯†æ’ä»¶**â€ï¼ŒGeth æŠŠæ‰€æœ‰å…±è¯†ç›¸å…³è´£ä»»è£…è¿›è¿™ä¸ªæ’ä»¶å†…ã€‚

---

# 1. Engine çš„æ€»ä½“è®¾è®¡å“²å­¦

### **Engine çš„ç‰¹ç‚¹ï¼š**

| åŠŸèƒ½                         | æè¿°                                            |
| -------------------------- | --------------------------------------------- |
| **äº¤æ˜“æ‰§è¡Œä¸åœ¨ Engine ä¸­**        | äº¤æ˜“æ‰§è¡Œï¼ˆEVMï¼‰åœ¨ miner/state æ‰§è¡Œï¼ŒEngine åªå…³å¿ƒåŒºå—å¤–å£³ã€‚     |
| **å…±è¯†è§„åˆ™å…¨éƒ¨åœ¨ Engine ä¸­**       | æ ¡éªŒéš¾åº¦ã€æ ¡éªŒç­¾åã€æ ¡éªŒå‡ºå—é¡ºåºã€validator set ç®¡ç†ç­‰ã€‚           |
| **Miner ä¸ Engine çš„åä½œéå¸¸æ˜ç¡®** | Miner å†³å®šäº¤æ˜“æ‰§è¡Œå’Œ header è‰ç¨¿ï¼Œè€Œ Engine å†³å®šâ€œå¦‚ä½• sealâ€ã€‚ |
| **æ”¯æŒ plug-in**             | Engine æ˜¯å¯æ’æ‹”çš„ï¼ŒPoA/PoW éƒ½ç»Ÿä¸€è¿™ä¸ªæ¥å£ã€‚                 |

---

# 2. æ¥å£é€æ¡æ·±åº¦è§£æ

ä¸‹é¢å¼€å§‹ â€œé€æ¡è®²è§£ Engine æ¥å£åŠŸèƒ½ + PoA ä¸­çš„çœŸå®è¡¨ç°â€ã€‚

---

## 2.1 **Author(header) â†’ å‡ºå—è€…æ˜¯è°ï¼Ÿ**

åœ¨ PoA å…±è¯†ä¸­ï¼š

* Header.Coinbase ä¸ä¸€å®šæ˜¯ç­¾åè€…ï¼Œç”±å…±è¯†ç¡®å®š
* å¿…é¡»ä» **header.ExtraData** æˆ– **Seal å­—æ®µï¼ˆClique çš„ signatureï¼‰** ä¸­æå–å‡ºçœŸå®å‡ºå—è€…

ä¾‹å¦‚ Cliqueï¼š

```go
func (c *Clique) Author(header *types.Header) (common.Address, error) {
    // ä» header.ExtraData ä¸­çš„ç­¾åæ¢å¤å‡º signer åœ°å€
}
```

**ä½œç”¨ï¼š**

* ç»™ block.coinbase è´¦æˆ·å‘å¥–åŠ±ï¼ˆå¦‚æœé“¾æœ‰å¥–åŠ±è§„åˆ™ï¼‰
* æä¾› RPC æ¥å£ï¼ˆeth_getBlockByâ€¦ ä¸­è¿”å› miner å­—æ®µï¼‰

â›ï¸ åœ¨ PoA ä¸­ author = signerï¼Œä¸ç­‰äº header.coinbaseã€‚

---

## 2.2 **VerifyHeader(...) â†’ å•ä¸ªåŒºå—å¤´éªŒè¯**

è¿™é‡Œæ˜¯å…±è¯†å±‚æœ€æ ¸å¿ƒçš„å…¥å£ã€‚

PoA çš„ VerifyHeader ä¼šæ£€æŸ¥ï¼š

| ç±»å‹                 | æ£€æŸ¥å†…å®¹                                                 |
| ------------------ | ---------------------------------------------------- |
| **ç»“æ„æ£€æŸ¥**           | gas limitã€timestampã€difficultyã€hash ç­‰æ˜¯å¦ç¬¦åˆè§„åˆ™          |
| **å‡ºå—è€…åˆæ³•æ€§**         | signer æ˜¯å¦åœ¨ validator set ä¸­                           |
| **epoch/round è§„åˆ™** | clique ä¼šæ£€æŸ¥ difficulty æ˜¯å¦æ˜¯ç­¾åè€… / in-turn / out-of-turn |
| **ç­¾åéªŒè¯**           | extraData[65:] ç­¾åæ˜¯å¦æ­£ç¡®                                |
| **æ—¶é—´æˆ³é—´éš”**          | æ˜¯å¦æ»¡è¶³ slot é—´éš”ï¼ˆä¾‹å¦‚ clique é»˜è®¤ 15sï¼‰                       |
| **å¥–åŠ±è§„åˆ™æ£€æŸ¥**         | header ä¸èƒ½éæ³•æ”¹å˜å¥–åŠ±ç›¸å…³å­—æ®µ                                  |

PoA æ²¡æœ‰å·¥ä½œé‡è¯æ˜ï¼Œå› æ­¤ VerifyHeader æ ¸å¿ƒæ˜¯ï¼š

> ç­¾åéªŒè¯ + é¡ºåºè§„åˆ™

---

## 2.3 **VerifyHeaders(...) â†’ æ‰¹é‡éªŒè¯**

Miner å¯¼å…¥ç½‘ç»œåŒºå—æ—¶ä¼šè°ƒç”¨æ­¤æ¥å£ã€‚

PoA çš„å®ç°é€šå¸¸ä¼šï¼š

* å¹¶è¡Œæ‰§è¡Œç­¾åéªŒè¯
* åš timestamp æ’åºåˆæ³•æ€§
* åš validator æŠ•ç¥¨/æ™‹å‡è§„åˆ™ï¼ˆClique UBFTï¼‰

è¿™æ˜¯ä¸ºæå‡åŒæ­¥é€Ÿåº¦è®¾è®¡çš„ã€‚

---

## 2.4 **VerifyUncles(...) â†’ å”å—éªŒè¯ï¼ˆPoA åŸºæœ¬ç¦ç”¨ï¼‰**

åœ¨ PoAï¼ˆClique / IBFTï¼‰ï¼š

ğŸ”¸ **ä¸å…è®¸ Uncles**
ğŸ”¸ Uncles åˆ—è¡¨å¿…é¡»ä¸ºç©º

å› æ­¤ VerifyUncles ä¼šç›´æ¥æŠ¥é”™ï¼š

```
if len(block.Uncles()) > 0 â†’ error: forbidden
```

---

## 2.5 **Prepare(...) â†’ Miner è‰ç¨¿ Header â†’ Engine ä¿®æ­£ header**

Prepare æ˜¯ â€œå¯åŠ¨å‡ºå—çš„ç¬¬ä¸€æ­¥â€ã€‚

Miner æä¾›ä¸€ä¸ªâ€œè‰ç¨¿ headerâ€ï¼ŒEngine è¡¥å……å…±è¯†å­—æ®µï¼š

PoAï¼ˆCliqueï¼‰ä¸­ Prepare ä¼šï¼š

| å­—æ®µ                    | è¡Œä¸º                                           |
| --------------------- | -------------------------------------------- |
| **header.Difficulty** | æ ¹æ®æ˜¯å¦è½®åˆ°è‡ªå·±å‡ºå— (in-turn / out-of-turn) è®¾ç½®ä¸º 2 æˆ– 1 |
| **header.ExtraData**  | åŠ å…¥ validator listï¼ˆæ¯ epochï¼‰                   |
| **header.Nonce**      | ç”¨äºæŠ•ç¥¨ç®¡ç†                                       |
| **header.Coinbase**   | å¯ä»¥ç”±å…±è¯†å±‚å¼ºåˆ¶ä¸ºæŸä¸ªåœ°å€ï¼ˆPoA é€šå¸¸æ— å¥–åŠ±ï¼‰                     |
| **header.GasLimit**   | æ ¹æ®å†å²åŒºå—åš gaslimit è°ƒæ•´                          |

Prepared header æ˜¯ä¸€ä¸ª â€œåŠæˆå“åŒºå—å¤´â€ã€‚

---

## 2.6 **Finalize(...) â†’ äº¤æ˜“æ‰§è¡Œåå¯¹ State çš„åå¤„ç†**

Finalize è¢« éªŒè¯èŠ‚ç‚¹ åœ¨â€œäº¤æ˜“æ‰§è¡Œå®Œæˆåâ€è°ƒç”¨ï¼š

åŠ¨ä½œåŒ…æ‹¬ï¼š

| åŠ¨ä½œ               | PoA æƒ…å†µ                        |
| ---------------- | ----------------------------- |
| è®¡ç®— block reward  | PoA é€šå¸¸ reward=0ï¼ˆCliqueï¼‰       |
| ç»´æŠ¤ validator set | æŠ•ç¥¨é€»è¾‘ç”Ÿæ•ˆï¼ˆClique æœ‰ä¸¤ç±»æŠ•ç¥¨ï¼šæ·»åŠ /ç§»é™¤ï¼‰    |
| withdrawals      | v1.13.15 ä¹‹å‰ ignoredï¼ˆæ²¡æœ‰ Merge) |

Finalize **ä¸ä¼šç»„è£…åŒºå—**ï¼Œåªä¼šå†™å…¥ StateDBã€‚ä¾‹å¦‚ï¼š

```go
func (c *Clique) Finalize(chain, header, state, txs, uncles, withdrawals) {
    // å¤„ç†æŠ•ç¥¨
    // åº”ç”¨ validator set å˜æ›´
    // ä¸ç»™ä»»ä½•äººå¥–åŠ±
}
```

---

## 2.7 **FinalizeAndAssemble(...) â†’ Finalize + æ„é€  block**

Miner çš„æœ€ç»ˆæ­¥éª¤ï¼š

```go
block := engine.FinalizeAndAssemble(...)
```

å®ƒä¼šï¼š

* è°ƒç”¨ Finalize å†™å…¥å¥–åŠ±/validator set
* ç»„è£…å®Œæ•´çš„ types.Blockï¼ˆå« body + txs + receiptsï¼‰
* è®¡ç®— txRootã€receiptRootã€stateRoot
* å¡«å¥½ Bloomã€GasUsedã€Size

PoA é‡Œ FinalizeAndAssemble æ²¡æœ‰å¤æ‚å¥–åŠ±ï¼Œä¸»è¦æ˜¯ï¼š

**æ„é€ æœ€ç»ˆ block + æ›´æ–° validator setã€‚**

---

## 2.8 **Seal(...) â†’ ç”Ÿæˆç­¾åå¹¶å›ä¼ ç»™ Miner**

**PoA Seal = ç”Ÿæˆç­¾å + å›ä¼ åŒºå—**

è¡Œä¸ºï¼š

* ä¸ä¼šé˜»å¡ï¼ˆå¼‚æ­¥è¿”å›ï¼‰
* å¤šä¸ª Seal ç»“æœå¯èƒ½åŒæ—¶ä¼ å‡ºï¼ˆIBFT round robin å¯å¤šè½®ç­¾åï¼‰

Clique çš„ Seal æµç¨‹ï¼š

```text
parent.header â†’ æ„é€  sealHash â†’ ç”¨ç§é’¥ç­¾å â†’ å¡«å…¥ extraData â†’ å‘é€ç»“æœ
```

â›ï¸ åœ¨ PoA é‡Œï¼ŒSeal ä¸åšè®¡ç®—ï¼Œåªåšâ€œç­¾åâ€ã€‚

Miner ä¼šï¼š

```go
engine.Seal(block, resultCh, stopCh)
```

æ”¶åˆ° resultCh åæ‰å¹¿æ’­åŒºå—ã€‚

---

## 2.9 **SealHash(header) â†’ éœ€è¦è¢«ç­¾åçš„ hash**

PoA ä¼šä» header ä¸­åˆ é™¤ç­¾åå­—æ®µï¼ˆextraData ä¸­å 65 å­—èŠ‚ï¼‰å† hashï¼š

```go
hasher := sha3.NewLegacyKeccak256()
rlp.Encode(hasher, strippedHeader)
```

SealHash æ˜¯ç­¾åå‰çš„â€œè£¸ hashâ€ã€‚

---

## 2.10 **CalcDifficulty(...) â†’ è®¡ç®—å½“å‰åŒºå—çš„éš¾åº¦**

åœ¨ PoA é‡Œï¼š

* difficulty ä¸ä»£è¡¨ç®—åŠ›
* æ˜¯å…±è¯†çŠ¶æ€æœºçš„ä¸€ä¸ªä¿¡å·é‡

ä¾‹å¦‚ cliqueï¼š

| in-turn        | out-of-turn    |
| -------------- | -------------- |
| difficulty = 2 | difficulty = 1 |

ç”¨äºé˜²æ­¢åˆ†å‰åç§»ï¼Œè®©é“¾å€¾å‘äº in-turn validator çš„é“¾ã€‚

> è¿™é‡Œéš¾åº¦è®¾è®¡æœ‰ä¸ªå·§å¦™çš„ç‚¹ï¼Œåˆ©ç”¨äº†æ€»éš¾åº¦è¶Šå¤§çš„é“¾ï¼Œè¶Šå°‘æ¦‚ç‡è¢«åˆ†å‰ï¼Œå› ä¸ºåˆæ³•çŸ¿å·¥å‡ºå—çš„éš¾åº¦å€¼æ›´å¤§å¤§ã€‚

---

## 2.11 **APIs() â†’ æš´éœ²å…±è¯†ç›¸å…³ RPC**

åŒ…æ‹¬ï¼š

* clique.getSigners
* clique.getSnapshot
* clique.proposals
* clique.propose / discard

è¿™äº› RPC ç”¨äº validator ç®¡ç†ã€‚

---

## 2.12 **Close() â†’ æ¸…ç†çº¿ç¨‹**

å…³é—­åå° goroutineï¼Œä¾‹å¦‚ï¼š

* IBFT çš„ timer/round manager
* Clique å¯èƒ½æ²¡æœ‰åå°çº¿ç¨‹ï¼Œä½†ä»æœ‰ç»“æ„æ¸…ç†

---

# 3. PoA Miner ä¸ Engine çš„å·¥ä½œæµ

## 3.1 **Miner æ„é€  block headerï¼ˆæœªç­¾åï¼‰**

```go
header := miner.createHeader(parent)
engine.Prepare(chain, header)
```

---

## 3.2 **EVM æ‰§è¡Œäº¤æ˜“å¹¶å†™å…¥çŠ¶æ€**

```go
for tx := range selectedTxs {
    applyTransaction(...)
}
```

ç”Ÿæˆï¼š

* receipts
* logs
* gasUsed
* stateRoot


---

## 3.3 **FinalizeAndAssemble â†’ æ„æˆå®Œæ•´ block**

```go
block := engine.FinalizeAndAssemble(...)
```

---

## 3.4 **Sealï¼ˆç­¾åï¼‰**

```go
engine.Seal(block, resultCh, stopCh)
```

Seal è¿”å›ç­¾ååçš„åŒºå—ã€‚

---

## 3.5 **Miner å¹¿æ’­åŒºå—**

```go
backend.BroadcastBlock(block)
```

---

## 3.6 **æµç¨‹å›¾**

> çŸ¿å·¥çš„å…±è¯†æµç¨‹ï¼š
```mermaid
flowchart TD
    A[å¼€å§‹æ–°å‡ºå—å‘¨æœŸ] --> B["åˆ›å»º Header<br/>å¹¶è°ƒç”¨ Engine.Prepare()"]
    B --> C[ä» TxPool é€‰æ‹©äº¤æ˜“]
    C --> D["æ‰§è¡Œäº¤æ˜“(EVM)<br/>ApplyTransactions()"]
    D --> E[ç”Ÿæˆ receipts & logs]
    E --> F["Engine.FinalizeAndAssemble()<br/>æ‹¼è£… Block"]
    F --> G["Engine.Seal()<br/>PoW nonce/PoA ç­¾å"]
    G --> H[ç”Ÿæˆæœ€ç»ˆ sealed block]
    H --> I["æäº¤ç»™æœ¬åœ°èŠ‚ç‚¹<br/>InsertBlock()"]
    I --> J[å¹¿æ’­åŒºå—]
```

> åŒæ­¥èŠ‚ç‚¹çš„å…±è¯†éªŒè¯æµç¨‹ï¼š
```mermaid
flowchart TD

    A[P2P æ¥æ”¶åˆ°æ–°åŒºå—] --> B[è§£ç  Block]
    B --> C["Engine.VerifyHeader()"]
    C --> D["Engine.VerifyUncles()"]
    D --> E["æ‰§è¡Œäº¤æ˜“(EVM)<br/>ApplyTransactions()"]
    E --> F["æ„é€  receiptsï¼ˆç”¨äºéªŒè¯ï¼‰"]
    F --> G["Engine.Finalize()<br/>å…±è¯†åå¤„ç†(å¥–åŠ±/çŠ¶æ€è§„åˆ™)"]
    G --> H[Compare StateRoot/ReceiptsRoot/Bloom]
    H --> I["å†™å…¥é“¾ä¸Šæ•°æ®åº“<br/>InsertBlock()"]
```

# ğŸ”´ å°ç»“

âœ” v1.13.15 çš„ Engine è®¾è®¡å“²å­¦
âœ” æ¯ä¸ª Engine æ¥å£åœ¨ PoA ä¸­çš„è¯¦ç»†ä½œç”¨
âœ” Clique/Aura/IBFT çš„è¡Œä¸ºå·®å¼‚ç‚¹
âœ” Miner è°ƒç”¨ Engine çš„å®Œæ•´æµç¨‹