
æœ¬ç¯‡å°†ç´§æ¥ç¬¬ä¸€ç¯‡çš„â€œå¤–å±‚æµç¨‹â€ï¼Œè¿›ä¸€æ­¥æ·±å…¥ **Geth çŸ¿å·¥åœ¨â€œå‡ºå—å‡†å¤‡é˜¶æ®µï¼ˆPre-Block Construction Stageï¼‰â€çš„å®Œæ•´ç»†èŠ‚**ï¼ŒåŒ…æ‹¬ï¼š

* äº¤æ˜“é€‰æ‹©æœºåˆ¶ï¼ˆLegacyTx / BlobTxï¼‰
* å¤šå­æ± è°ƒåº¦
* æ‰§è¡Œå¼•æ“ï¼ˆEVMï¼‰ä¸çŠ¶æ€æ£€æŸ¥
* åŒºå—æ¨¡æ¿æ„å»º
* æ‰‹ç»­è´¹ / ä¼˜å…ˆè´¹ / MEV ç›¸å…³æ¥å£
* åŒºå—å¯å°è£…æ€§ï¼ˆsealabilityï¼‰åˆ¤æ–­

> ğŸŒŸ **æœ¬ç¯‡å®šä½ï¼šäº¤æ˜“è¿›å…¥åŒºå—å‰ï¼ŒGeth å†…éƒ¨å¦‚ä½•ç»„ç»‡ã€ç­›é€‰ä¸æ‰§è¡Œäº¤æ˜“ï¼Œæœ€ç»ˆå½¢æˆå¯äº¤ç»™å…±è¯†å±‚å°è£…çš„â€œåŒºå—æ¨¡æ¿ï¼ˆBlock Templateï¼‰â€ã€‚**
> ğŸŒŸ **å…±è¯†éƒ¨åˆ†ï¼ˆä¾‹å¦‚ PoW/PoS ç­¾åã€éšæœºæ•°ã€slotã€validator å·¥ä½œï¼‰ä¸€å¾‹æŠ½è±¡ä¸ºæ¥å£ï¼Œä¸æ·±å…¥å†…éƒ¨ã€‚**

---

# **ç¬¬äºŒç¯‡ï¼šåŒºå—æ„å»ºé˜¶æ®µå…¨è§£æ**

---

# **ä¸€ã€æ€»è§ˆï¼šåŒºå—æ„å»ºé˜¶æ®µçš„ç›®æ ‡**

å½“å…±è¯†å±‚ï¼ˆCLï¼‰å‘æ‰§è¡Œå±‚ï¼ˆEL/Gethï¼‰å‘å‡ºè¯·æ±‚ï¼š

```
engine_forkchoiceUpdatedV2
engine_getPayloadV3
```

Geth çš„ä»»åŠ¡æ˜¯ï¼š

1. **æ„å»ºä¸€ä¸ª block templateï¼ˆåŒºå—æ¨¡æ¿ï¼‰**
2. å°½å¯èƒ½ä»äº¤æ˜“æ± ä¸­æŒ‘é€‰æ”¶ç›Šæœ€é«˜ä¸”èƒ½è¢«æ‰§è¡Œçš„äº¤æ˜“
3. æ¨¡æ‹Ÿæ‰§è¡Œæ‰€æœ‰äº¤æ˜“ï¼ˆEVM æ‰§è¡Œï¼‰
4. ä¿è¯åŒºå— gas é™åˆ¶ã€blob é™åˆ¶ã€baseFee è§„åˆ™
5. è¿”å›â€œå¯ä»¥è¢«å°è£…çš„åŒºå—ä½“â€ï¼ˆæœªç­¾å / æœªå°è£…ï¼‰

---

# **äºŒã€åŒºå—æ„å»ºä¸»æµç¨‹ï¼ˆBlockBuilderï¼‰**

Geth ç”¨ä¸€ä¸ªç±»ä¼¼ä¸‹å›¾çš„æµç¨‹æ„å»ºåŒºå—ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```
func BuildBlockTemplate(parent, time, suggested_fee_recipient):
    st = copy(parent_state)
    header = makeHeader(parent, time, st)
    txs = SelectTransactions(st, header)
    blobs = SelectBlobs(st, header)
    applyAll(st, txs + blobs)
    finalizeHeader(header, st)
    return Block(header, txs + blobs)
```

å…³é”®æ¨¡å—ï¼š

* **çŠ¶æ€å¤åˆ¶**ï¼šåŸºäº parent block çš„ post-state å…‹éš†ä¸€ä¸ª working state
* **æ„é€  header åˆç¨¿**ï¼šåŒ…å« parentHashã€gasLimitã€baseFeeã€feeRecipient
* **ä»äº¤æ˜“æ± é€‰æ‹©äº¤æ˜“ï¼ˆä¸¤å¤§æ± ï¼šLegacyPool + BlobPoolï¼‰**
* **æ‰§è¡Œäº¤æ˜“**
* **Finalize header**
* **è¿”å›åŒºå—æ¨¡æ¿**

ä¸‹é¢åˆ†å‡ éƒ¨åˆ†æ·±å…¥è®²è§£ã€‚

---

# **ä¸‰ã€äº¤æ˜“é€‰æ‹©æœºåˆ¶**

åŒºå—æ„å»ºæœ€æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯ï¼š

### **SelectTransactions() â€” ä»å¤šä¸ªå­æ± ä¼˜å…ˆé˜Ÿåˆ—å–æœ€æœ‰ä»·å€¼çš„äº¤æ˜“**

Geth çš„ Transaction Poolï¼ˆTxPoolï¼‰ç»“æ„å¦‚ä¸‹ï¼š

```
TxPool
 â”œâ”€â”€ LegacyPool   ï¼ˆæ™®é€šäº¤æ˜“ï¼‰
 â””â”€â”€ BlobPool     ï¼ˆEIP-4844 blob äº¤æ˜“ï¼‰
```

æ¯ä¸ªå­æ± å†…éƒ¨åˆæœ‰å¤šçº§ç»“æ„ï¼š

* pending
* queued
* pricing queue
* eviction
* per-account ordering
* nonce dependencies

æœ¬ç¯‡é‡ç‚¹æ˜¯ **é€‰äº¤æ˜“è¿›å…¥åŒºå—ï¼ˆblock buildingï¼‰**ï¼Œä¸æ˜¯äº¤æ˜“æ± æœ¬èº«çš„å­˜å‚¨ç»“æ„ã€‚

---

## **3.1 äº¤æ˜“é€‰æ‹©ç®—æ³•æ€»ä½“ç»“æ„**

Geth çš„åŒºå—æ„å»ºäº¤æ˜“é€‰æ‹©éµå¾ªï¼š

### **â‘  å…ˆæŒ‰æ”¶ç›Šæ’åºï¼ˆTip / BlobFeeï¼‰**

* Legacy äº¤æ˜“æ’åºï¼š

  ```
  priority = effectiveGasTip
  ```
* Blob äº¤æ˜“æ’åºï¼š

  ```
  priority = blobFeeCap - blobBaseFee
  ```

### **â‘¡ æŒ‰è´¦å· nonce ä¸²è”**

äº¤æ˜“æ± å†…éƒ¨ä¿è¯ï¼š

* å¯¹åŒä¸€ä¸ªè´¦å·ï¼ˆsenderï¼‰å¿…é¡»ä» nonce æœ€å°çš„å¼€å§‹ä¾æ¬¡åŠ å…¥åŒºå—
* å¦‚é‡åˆ° gapï¼ˆæ¯”å¦‚ nonce=10 ç¼ºå¤±ï¼Œè€Œæ¥äº† nonce=11ï¼‰ï¼Œ11 ç¦æ­¢è¿›å…¥ block builder

### **â‘¢ åŠ¨æ€ gas è®¡ç®—**

æ„å»ºåŒºå—è¿‡ç¨‹ä¼šä¸æ–­ï¼š

* ç»Ÿè®¡å½“å‰åŒºå—å·²ä½¿ç”¨ gas
* åŠ¨æ€åˆ¤æ–­åŒºå—æ˜¯å¦è¿˜èƒ½åŠ å…¥æ›´å¤šäº¤æ˜“
* å¯¹ 4844 blob äº¤æ˜“è¦å¤„ç† `blobGasUsed`

---

## **3.2 è¯¦ç»†æµç¨‹ï¼šä»å„å­æ± é€‰æ‹©äº¤æ˜“**

ç®€åŒ–åçš„ä¼ªæµç¨‹ï¼š

```
while block not full:
    tx = next highest priority tx from (LegacyPool, BlobPool)
    
    if cannot include:
        skip or move to next
        continue

    if executing tx fails:
        - if sender balance insufficient â†’ drop this sender's whole nonce sequence
        - if gasä¸è¶³/invalid â†’ skip this tx only
        continue

    include tx into block
```

å¤šæ± è°ƒåº¦é‡‡ç”¨ **å¤šè·¯å½’å¹¶ï¼ˆmulti-way mergeï¼‰**ï¼š

* LegacyPool â†’ highest tip tx
* BlobPool â†’ highest blob fee tx
* è½®è¯¢æ¯”è¾ƒä¸¤ä¸ªæ± å­å¤´éƒ¨ï¼Œé€‰æ‹©æ”¶ç›Šæ›´é«˜è€…

---

# **å››ã€æ‰§è¡Œå¼•æ“ï¼ˆEVMï¼‰é¢„æ‰§è¡Œé˜¶æ®µ**

Geth åœ¨æ„å»ºåŒºå—æ—¶å¿…é¡»å¯¹æ¯ä¸ªäº¤æ˜“ï¼š

1. ä½¿ç”¨ working state æ‰§è¡Œ
2. æ£€æŸ¥ä½™é¢ã€nonceã€gasã€ç­¾å
3. æ£€æŸ¥ calldata æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ blob sidecarï¼ˆ4844ï¼‰

### **EVM æ‰§è¡Œçš„ä½ç½®ï¼š**

ä»£ç å…¥å£ï¼š

```
core/state_processor.go
core/evm.go
core/blockchain.go
```

åœ¨æ„å»ºåŒºå—æ—¶ï¼š

```
state.TransitionDb()
```

æ¯ä¸ªäº¤æ˜“æ‰§è¡Œç»“æœè¿”å›ï¼š

* gas used
* logs
* touched accounts
* storage writes
* refunds

è¿™äº›å†…å®¹ä¼šç”¨äºï¼š

* æ›´æ–° working state
* æ›´æ–° block txRoot / receiptRoot / logsBloom

---

# **äº”ã€åŒºå—å¤´æ„å»ºï¼ˆBlock Header Constructionï¼‰**

åŒºå—å¤´åˆç¨¿ï¼š

```
parentHash
beneficiary (suggested fee recipient)
stateRoot (æœ€ç»ˆæ‰èƒ½å¡«)
receiptsTrie
gasLimit
gasUsed
baseFee
blobGasUsed
excessBlobGas
timestamp
```

åŒºå—æ„å»ºè¿‡ç¨‹ä¼šä¸æ–­ä¿®æ”¹ header å­—æ®µï¼š

* æ¯åŠ å…¥ä¸€ç¬”äº¤æ˜“ â†’ gasUsed å¢åŠ 
* æ¯åŠ å…¥ blob tx â†’ blobGasUsed æ›´æ–°
* æœ€ç»ˆ st.Commit() â†’ stateRoot å¡«å†™
* æ”¶æ®ç”Ÿæˆ â†’ receiptsRoot å¡«å†™

---

# **å…­ã€æ‰‹ç»­è´¹ã€å¥–åŠ±ä¸ MEV ç›¸å…³æ¥å£**

### **6.1 baseFeeï¼ˆEIP-1559ï¼‰**

åŒºå—æ„å»ºå¿…é¡»éµå®ˆï¼š

```
baseFee(next block) = adjust(parent.baseFee, gasUsed, gasTarget)
```

è¿™ä¸ªå½±å“ Legacy äº¤æ˜“çš„æœ€ä½ä¸Šé“¾ä»·æ ¼ï¼š

```
effectiveGasTip + baseFee <= gasFeeCap
```

### **6.2 blobBaseFeeï¼ˆEIP-4844ï¼‰**

å½±å“ blob tx æ˜¯å¦èƒ½è¢«æ¥å—ï¼š

```
blobFeeCap >= blobBaseFee
```

### **6.3 feeRecipient**

ç”±å…±è¯†å±‚ï¼ˆæƒé™èŠ‚ç‚¹/validatorï¼‰æŒ‡å®šï¼š

```
engine_forkchoiceUpdatedV2(payloadAttributes.suggestedFeeRecipient)
```

Geth åªè´Ÿè´£æ‰§è¡Œï¼š

* çŸ¿å·¥è´¹ï¼ˆtipsï¼‰å‘é€åˆ°è¯¥åœ°å€
* MEV rewards ç”±å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ mev-boostï¼‰å¤„ç†
  Geth åœ¨æ­¤é˜¶æ®µåªæ˜¯é€æ˜å¤„ç†å·²æ’åºçš„äº¤æ˜“ï¼ˆæ— å†…ç½®æ‹å–æœºåˆ¶ï¼‰

---

# **ä¸ƒã€åŒºå—å¯å°è£…æ€§ï¼ˆsealabilityï¼‰åˆ¤æ–­**

åŒºå—æ„å»ºå®Œæˆåï¼ŒGeth ä¼šæ ¡éªŒè¯¥åŒºå—æ˜¯å¦æ»¡è¶³ï¼š

* gasUsed â‰¤ gasLimit
* blobGasUsed â‰¤ blobLimit
* timestamp â‰¥ parent.timestamp
* correct baseFee / blobBaseFee
* nonce & uncle rulesï¼ˆç®€åŒ–ï¼‰
* receiptsRootã€stateRoot ä¸€è‡´

é€šè¿‡åå³å¯äº¤ä»˜ç»™å…±è¯†å±‚ï¼š

```
engine_getPayloadV3 â†’ è¿”å›åŒºå—æ¨¡æ¿
```

---

# **å…«ã€å®Œæ•´æµç¨‹å¯è§†åŒ–**


```mermaid
flowchart TD
    A["å¼€å§‹: æ¥æ”¶ engine_forkchoiceUpdated"] --> B[å¤åˆ¶ parent state]
    B --> C[æ„é€  header åˆç¨¿]
    C --> D[ä» LegacyPool/BlobPool é€‰æ‹©æœ€é«˜æ”¶ç›Šäº¤æ˜“]
    D --> E{èƒ½åŠ å…¥åŒºå—?}
    
    E -->|å¦| D
    E -->|æ˜¯| F["æ‰§è¡Œäº¤æ˜“(EVM)"]
    F --> G{æ‰§è¡ŒæˆåŠŸ?}
    
    G -->|å¦| D
    G -->|æ˜¯| H[æ›´æ–° working state]
    H --> I[æ›´æ–° header.gasUsed / blobGasUsed]
    
    I --> J{åŒºå—å·²æ»¡?}
    J -->|å¦| D
    J -->|æ˜¯| K[Finalize header: stateRoot, receiptsRoot, logsBloom]
    
    K --> L[ç”Ÿæˆ Block Template]
    L --> M["è¿”å› engine_getPayload â†’ å…±è¯†å±‚"]
    M --> N[ç»“æŸ]
```

---

