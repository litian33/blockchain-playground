# 区块链密码学基础
---

### 1. Hash 算法（哈希函数）

Hash 算法是密码学的瑞士军刀，应用无处不在。

**是什么？**
一种将**任意长度**的输入数据（如文件、文本）映射为**固定长度**、看似随机的字符串（哈希值）的函数。

**核心特性：**
1.  **确定性**：相同输入永远产生相同输出。
2.  **单向性**：从哈希值**无法反推**出原始输入。
3.  **雪崩效应**：输入哪怕只改变一个比特，输出的哈希值也会发生巨大、不可预测的变化。
4.  **抗碰撞性**：极难找到两个不同的输入，使得它们的哈希值相同。

**常见算法：**
*   **SHA-256**： 比特币和以太坊广泛使用。输出 256 位。
*   **Keccak-256**： 以太坊官方标准，是 SHA-3 的变体。
*   **BLAKE2/3**： 性能更优，在一些新区块链和文件中使用。

**在区块链中的应用：**
*   **交易和区块ID**： 对交易内容或区块头进行哈希，生成唯一标识符。
*   **默克尔树**： 将大量交易哈希组织成一个树结构，实现高效、安全的交易验证。
*   **工作量证明（PoW）**： 矿工不断尝试计算区块哈希，使其满足特定难度要求。
*   **密钥派生**： 从助记词生成种子，再从种子派生密钥。

---

### 2. 对称加密

**是什么？**
加密和解密使用**同一把密钥**的算法。

**核心特性：**
*   **速度快**： 比非对称加密快几个数量级，适合加密大量数据。
*   **密钥分发问题**： 如何安全地将密钥传递给通信方是个经典难题。

**常见算法：**
*   **AES**： 全球标准，速度快，安全性极高。密钥长度通常为 128, 192 或 256 位。
*   **ChaCha20**： 一种流密码，在移动设备上性能优异，常与 Poly1305 认证器搭配使用。

**应用场景：**
*   **加密钱包文件**： 如 `keystore` 文件就是用对称加密（通过密码派生出的密钥）来加密你的私钥。
*   **安全通信信道**： 在 TLS 1.3 中，握手完成后，后续通信使用对称加密来保障数据机密性。
*   **加密数据库或硬盘**。

---

### 3. 非对称加密

这是区块链身份和所有权系统的核心。

**是什么？**
使用一对数学上相关的密钥：**公钥**和**私钥**。
*   **公钥**： 可以公开给任何人，用于**加密**或**验证签名**。
*   **私钥**： 必须绝对保密，用于**解密**或**创建签名**。

**核心特性：**
*   **解决密钥分发问题**： 你只需要公布公钥，别人就能用它给你发送加密信息。
*   **数字签名**： 用私钥对消息签名，任何人都可以用对应的公钥验证该签名是否有效，从而证明 **“消息由私钥持有者发出”** 且 **“消息在传输中未被篡改”**。

#### a) ECDSA

**是什么？**
基于椭圆曲线密码学的数字签名算法。

**细节：**
*   **曲线**： 以太坊和比特币使用 `secp256k1` 曲线。
*   **流程**：
    1.  对消息 `m` 计算哈希 `hash(m)`。
    2.  使用私钥 `sk` 和哈希值 `hash(m)` 通过椭圆曲线运算生成签名 `(r, s)`。
    3.  验证者使用公钥 `pk`、消息哈希 `hash(m)` 和签名 `(r, s)` 进行运算，如果通过则签名有效。
*   **随机数 `k`**： 在生成签名时，必须使用一个密码学安全的随机数 `k`。**重复使用 `k` 会导致私钥被直接计算出！** 这就是历史上某些钱包被黑客攻击的原因。

**应用：**
*   **比特币、以太坊（外部账户）** 的交易签名。

#### b) EdDSA

**是什么？**
一种更现代、更安全、更高效的基于扭曲爱德华兹曲线的数字签名算法。

**细节：**
*   **曲线**： 最常用的是 `Ed25519`（对应 Curve25519）。
*   **与 ECDSA 的关键区别**：
    1.  **确定性**： 它的随机数 `k` 是由私钥和消息本身**确定性派生**的，彻底消除了因随机数生成器失败而导致私钥泄漏的风险。
    2.  **安全性**： 设计上更易于安全实现，对侧信道攻击的抵抗力更强。
    3.  **性能**： 签名和验证速度更快。

**应用：**
*   **Solana、Ripple、Monero** 等区块链。
*   **SSH、TLS** 等现代网络协议。

---

## 4. 密钥安全管理体系

### 4.1 密钥的生成与派生

*   **真随机数生成器**：是安全的源头。可使用硬件RNG或由操作系统提供的 `/dev/urandom`（Linux）或 `CryptGenRandom`（Windows）。
*   **助记词（BIP39）**：
    *   将熵（128/160/192/224/256位）通过HMAC-SHA512生成校验和，将“熵+校验和”按每11位分割，映射到一个2048个单词的预定义列表中。
    *   **示例**：128位熵 -> 12个单词。
*   **分层确定性钱包（BIP32）**：
    *   从一个**主种子**（由助记词通过PBKDF2生成）派生出无限层级的密钥树。
    *   使用**扩展公钥**可以派生出所有子公钥，而无需暴露私钥，便于监控钱包。
    *   **派生路径**：`m/purpose'/coin_type'/account'/change/address_index`。例如，以太坊的第一个地址路径为：`m/44'/60'/0'/0/0`。
*   **密钥派生函数**：
    *   **PBKDF2**： 通过多次哈希迭代（如2048次）来减缓暴力破解。
    *   **Scrypt**： 内存密集型，能更好地抵御ASIC攻击。

### 4.2 密钥的存储

*   **软件钱包（热钱包）**：
    *   **安全考量**：易受恶意软件、病毒、系统漏洞威胁。
    *   **最佳实践**：使用操作系统提供的安全存储区（如Keychain（macOS）、Credential Manager（Windows））。
*   **硬件钱包（冷钱包）**：
    *   **原理**：私钥在安全芯片（SE）或隔离环境中生成和存储，永不离开设备。交易在设备内签名后，仅将签名结果输出。
    *   **优势**：即使在不安全的电脑上使用，私钥也不会泄漏。
*   **智能合约钱包**：
    *   **原理**：资产由智能合约持有，访问逻辑由合约代码定义。
    *   **功能**：
        *   **社交恢复**：指定一组守护人，在你丢失设备时，可通过他们共同签名来更换签名密钥。
        *   **多签交易**：需要多个密钥批准才能执行高价值交易。
        *   **交易限制**：设置每日转账限额。
        *   **手续费代付**：允许第三方为你支付交易Gas费。

### 4.3 密钥的使用与生命周期管理

*   **密钥轮换**：定期更新密钥以限制密钥泄露造成的损害。对于非对称密钥，需要将新公钥重新分发给所有通信方。
*   **密钥撤销**：建立有效的机制（如证书撤销列表CRL）来宣告一个密钥（尤其是用于签名验证的公钥）不再有效。
*   **密钥备份与恢复**：
    *   ** Shamir秘密共享**：将种子拆分为 `n` 个分片，只需其中任意 `t` 个（`t-of-n`）即可恢复原始种子。分片可分给不同人保管。
    *   **物理钢板**：用于防火、防水、防腐蚀地备份助记词。

---

## 总结与安全准则

1.  **不要自己实现加密原语**：始终使用经过严格审计、广泛使用的成熟密码学库。
2.  **遵循最小权限原则**：应用程序只应访问完成其功能所必需的最小密钥集合。
3.  **纵深防御**：不依赖单一安全措施。结合使用冷存储、多签、硬件安全模块等。
4.  **保持系统更新**：及时更新库和操作系统，以修补已知漏洞。
5.  **威胁建模**：识别你的资产、面临的威胁以及攻击向量，从而有针对性地部署安全措施。
