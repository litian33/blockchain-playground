

## 1. æ”»å‡»æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º/ä¸‹æº¢ï¼Ÿ

**æ•´æ•°æº¢å‡º** å’Œ **æ•´æ•°ä¸‹æº¢** æ˜¯è®¡ç®—æœºç¨‹åºä¸­å½“ç®—æœ¯è¿ç®—ç»“æœè¶…å‡ºæ•°æ®ç±»å‹æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´æ—¶å‘ç”Ÿçš„ç°è±¡ã€‚

| ç±»å‹ | å®šä¹‰ | ç¤ºä¾‹ (uint8) |
|------|------|-------------|
| **æº¢å‡º** | ç»“æœè¶…è¿‡æœ€å¤§å€¼ | 255 + 1 = 0 |
| **ä¸‹æº¢** | ç»“æœå°äºæœ€å°å€¼ | 0 - 1 = 255 |

### 1.2 åœ¨åŒºå—é“¾ä¸­çš„å½±å“

åœ¨ Solidity ä¸­ï¼Œè¿™ç§æ¼æ´å¯èƒ½å¯¼è‡´ï¼š
- ğŸ”¥ ä»£å¸æ— é™å¢å‘
- ğŸ’¸ ä½™é¢å¼‚å¸¸å‡å°‘æˆ–å¢åŠ 
- ğŸš« æƒé™æ£€æŸ¥ç»•è¿‡
- ğŸ“‰ ä»·æ ¼è®¡ç®—é”™è¯¯

---

## 2. æŠ€æœ¯åŸç†æ·±åº¦è§£æ

### 2.1 æ•°æ®èŒƒå›´åŸºç¡€

**Solidity æ•´æ•°ç±»å‹èŒƒå›´**ï¼š

| ç±»å‹ | å¤§å° | æœ€å°å€¼ | æœ€å¤§å€¼ |
|------|------|--------|--------|
| `uint8` | 8ä½ | 0 | 255 |
| `uint256` | 256ä½ | 0 | 2Â²âµâ¶ - 1 |
| `int8` | 8ä½ | -128 | 127 |

### 2.2 æº¢å‡º/ä¸‹æº¢æœºåˆ¶

```solidity
// æº¢å‡ºç¤ºä¾‹
uint8 max = 255;
max + 1 = 0;  // æº¢å‡ºå›åˆ°æœ€å°å€¼

// ä¸‹æº¢ç¤ºä¾‹  
uint8 min = 0;
min - 1 = 255; // ä¸‹æº¢å›åˆ°æœ€å¤§å€¼
```

---

## 3. å†å²æ¼æ´æ¡ˆä¾‹åˆ†æ

### 3.1 ç»å…¸æ¡ˆä¾‹ï¼šERC20 ä»£å¸æ¼æ´

**æ¼æ´åˆçº¦ç¤ºä¾‹**ï¼š
```solidity
// ğŸš¨ å­˜åœ¨æº¢å‡ºæ¼æ´çš„æ—§ç‰ˆä»£å¸åˆçº¦ (Solidity < 0.8)
contract VulnerableToken {
    mapping(address => uint256) public balances;
    uint256 public totalSupply;
    
    // è½¬è´¦å‡½æ•° - å­˜åœ¨ä¸‹æº¢æ¼æ´
    function transfer(address _to, uint256 _value) public returns (bool) {
        // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
        require(balances[msg.sender] >= _value);
        
        // ğŸš¨ æ¼æ´ç‚¹ï¼šå¯èƒ½å‘ç”Ÿä¸‹æº¢
        balances[msg.sender] -= _value;
        balances[_to] += _value;
        
        return true;
    }
    
    // é“¸å¸å‡½æ•° - å­˜åœ¨æº¢å‡ºæ¼æ´  
    function mint(address _to, uint256 _amount) public {
        // ğŸš¨ æ¼æ´ç‚¹ï¼šå¯èƒ½å‘ç”Ÿæº¢å‡º
        totalSupply += _amount;
        balances[_to] += _amount;
    }
}
```

**æ”»å‡»åœºæ™¯**ï¼š
1. **ä¸‹æº¢æ”»å‡»**ï¼šæ”»å‡»è€…æ‹¥æœ‰ 0 ä¸ªä»£å¸ï¼Œä½†å°è¯•è½¬è´¦ 1 ä¸ªä»£å¸
   ```
   balances[msg.sender] = 0
   0 - 1 = 2Â²âµâ¶ - 1 (ä¸‹æº¢)
   æ”»å‡»è€…ä½™é¢å˜æˆæœ€å¤§å€¼ï¼
   ```

2. **æº¢å‡ºæ”»å‡»**ï¼šæ¥è¿‘æœ€å¤§ä¾›åº”é‡æ—¶ç»§ç»­é“¸å¸
   ```
   totalSupply = 2Â²âµâ¶ - 1
   totalSupply + 1 = 0 (æº¢å‡º)
   æ€»ä¾›åº”é‡é‡ç½®ä¸º 0ï¼
   ```

### 3.2 çœŸå®ä¸–ç•Œæ¡ˆä¾‹ï¼šBEC ä»£å¸æ”»å‡»ï¼ˆ2018å¹´ï¼‰

**äº‹ä»¶è¯¦æƒ…**ï¼š
- **é¡¹ç›®**ï¼š BeautyChain (BEC)
- **æŸå¤±**ï¼š çº¦ $30äº¿ å¸‚å€¼è’¸å‘
- **æ¼æ´**ï¼š æ‰¹é‡è½¬è´¦å‡½æ•°ä¸­çš„æº¢å‡ºæ¼æ´

**æ¼æ´ä»£ç **ï¼š
```solidity
function batchTransfer(address[] _receivers, uint256 _value) public {
    uint cnt = _receivers.length;
    
    // ğŸš¨ æº¢å‡ºç‚¹ï¼š_value * cnt å¯èƒ½æº¢å‡º
    uint256 amount = uint256(cnt) * _value;
    require(amount > 0); // è¿™ä¸ªæ£€æŸ¥å¯ä»¥è¢«ç»•è¿‡
    
    require(balances[msg.sender] >= amount);
    balances[msg.sender] = balances[msg.sender] - amount;
    
    for (uint i = 0; i < cnt; i++) {
        balances[_receivers[i]] = balances[_receivers[i]] + _value;
    }
}
```

**æ”»å‡»è¿‡ç¨‹**ï¼š
1. æ”»å‡»è€…è°ƒç”¨ `batchTransfer`ï¼Œè®¾ç½® `_value = 2Â¹âµâ¶`
2. å³ä½¿åªå‘ 1 ä¸ªåœ°å€è½¬è´¦ï¼Œ`amount = 2Â¹âµâ¶ * 1 = 2Â¹âµâ¶`
3. ä½† `2Â¹âµâ¶` åœ¨ uint256 ä¸­ä¼šæº¢å‡ºï¼Œå®é™… `amount = 0`
4. æ£€æŸ¥ `balances[msg.sender] >= 0` é€šè¿‡
5. æ”»å‡»è€…ä½™é¢ä¸å˜ï¼Œä½†æ¥æ”¶è€…è·å¾—å·¨é¢ä»£å¸

---

## 4. Solidity 0.8.x çš„é˜²æŠ¤æœºåˆ¶

### 4.1 å†…ç½®å®‰å…¨ç®—æœ¯

**Solidity 0.8.0 å¼•å…¥çš„å˜æ›´**ï¼š
- âœ… æ‰€æœ‰ç®—æœ¯è¿ç®—é»˜è®¤è¿›è¡Œæº¢å‡ºæ£€æŸ¥
- âœ… æº¢å‡ºæ—¶è‡ªåŠ¨ `revert` è€Œä¸æ˜¯é™é»˜åŒ…è£…
- âœ… ä½¿ç”¨ `unchecked` å—å¯ä»¥æ¢å¤æ—§è¡Œä¸º

**å®‰å…¨ç¤ºä¾‹**ï¼š
```solidity
// Solidity >= 0.8.0 - è‡ªåŠ¨é˜²æŠ¤
contract SafeToken {
    function transfer(address to, uint256 amount) public {
        require(balances[msg.sender] >= amount);
        
        // âœ… è‡ªåŠ¨è¿›è¡Œä¸‹æº¢æ£€æŸ¥
        balances[msg.sender] -= amount;  // å¦‚æœä¸è¶³ä¼š revert
        balances[to] += amount;          // å¦‚æœæº¢å‡ºä¼š revert
    }
}
```

### 4.2 æœªæ£€æŸ¥å—çš„ä½¿ç”¨

**æ€§èƒ½ä¼˜åŒ–åœºæ™¯**ï¼š
```solidity
function efficientLoop(uint256 n) public pure returns (uint256) {
    uint256 sum = 0;
    
    // åœ¨ç¡®å®šä¸ä¼šæº¢å‡ºçš„æƒ…å†µä¸‹ä½¿ç”¨ unchecked
    unchecked {
        for (uint256 i = 0; i < n; i++) {
            sum += i; // å·²çŸ¥ä¸ä¼šæº¢å‡º
        }
    }
    return sum;
}
```

---

## 5. æ—§ç‰ˆæœ¬åˆçº¦çš„é˜²æŠ¤æ¨¡å¼

### 5.1 SafeMath åº“ï¼ˆSolidity < 0.8ï¼‰

**ä¼ ç»Ÿé˜²æŠ¤æ–¹å¼**ï¼š
```solidity
// OpenZeppelin SafeMath åº“
library SafeMath {
    function sub(uint256 a, uint256 b) internal pure returns (uint256) {
        require(b <= a, "SafeMath: subtraction overflow");
        return a - b;
    }
    
    function add(uint256 a, uint256 b) internal pure returns (uint256) {
        uint256 c = a + b;
        require(c >= a, "SafeMath: addition overflow");
        return c;
    }
}

// ä½¿ç”¨ SafeMath çš„åˆçº¦
contract LegacyToken {
    using SafeMath for uint256;
    mapping(address => uint256) balances;
    
    function safeTransfer(address to, uint256 amount) public {
        require(balances[msg.sender] >= amount);
        balances[msg.sender] = balances[msg.sender].sub(amount); // âœ… å®‰å…¨å‡æ³•
        balances[to] = balances[to].add(amount); // âœ… å®‰å…¨åŠ æ³•
    }
}
```

### 5.2 è‡ªå®šä¹‰æ£€æŸ¥å‡½æ•°

**é’ˆå¯¹ç‰¹å®šåœºæ™¯çš„æ£€æŸ¥**ï¼š
```solidity
function safeMultiply(uint256 a, uint256 b) internal pure returns (uint256) {
    if (a == 0) return 0;
    uint256 c = a * b;
    require(c / a == b, "Multiplication overflow");
    return c;
}

function safeSubtract(uint256 a, uint256 b) internal pure returns (uint256) {
    require(b <= a, "Subtraction underflow");
    return a - b;
}
```

---

## 6. å¤æ‚æ”»å‡»åœºæ™¯åˆ†æ

### 6.1 ä»·æ ¼è®¡ç®—æº¢å‡º

**æ¼æ´åœºæ™¯**ï¼š
```solidity
// ğŸš¨ ä»·æ ¼è®¡ç®—ä¸­çš„æº¢å‡º
function calculateOutputAmount(uint256 inputAmount, uint256 reserveIn, uint256 reserveOut) 
    public pure returns (uint256) {
    
    // åŸºäºæ’å®šä¹˜ç§¯å…¬å¼çš„è®¡ç®—
    uint256 numerator = inputAmount * reserveOut;
    uint256 denominator = reserveIn + inputAmount;
    
    // ğŸš¨ numerator æˆ– denominator å¯èƒ½æº¢å‡º
    return numerator / denominator;
}
```

**é˜²æŠ¤æ–¹æ¡ˆ**ï¼š
```solidity
function safeCalculateOutputAmount(uint256 inputAmount, uint256 reserveIn, uint256 reserveOut)
    public pure returns (uint256) {
    
    require(inputAmount > 0 && reserveIn > 0 && reserveOut > 0);
    require(reserveIn + inputAmount > reserveIn); // æ£€æŸ¥åŠ æ³•æº¢å‡º
    
    uint256 numerator;
    uint256 denominator = reserveIn + inputAmount;
    
    // ä½¿ç”¨å®‰å…¨ä¹˜æ³•
    unchecked {
        numerator = inputAmount * reserveOut; // åœ¨å·²çŸ¥å®‰å…¨æ—¶ä½¿ç”¨ unchecked
    }
    // æˆ–è€…ä½¿ç”¨å®‰å…¨æ•°å­¦åº“
    // numerator = inputAmount.safeMul(reserveOut);
    
    return numerator / denominator;
}
```

### 6.2 æ—¶é—´è®¡ç®—ä¸‹æº¢

**æ¼æ´åœºæ™¯**ï¼š
```solidity
// ğŸš¨ æ—¶é—´è®¡ç®—ä¸­çš„ä¸‹æº¢
function isExpired(uint256 expirationTime) public view returns (bool) {
    // å¦‚æœ expirationTime å¾ˆå°ï¼Œnow - expirationTime å¯èƒ½ä¸‹æº¢
    return (now - expirationTime) > 30 days;
}
```

**é˜²æŠ¤æ–¹æ¡ˆ**ï¼š
```solidity
function safeIsExpired(uint256 expirationTime) public view returns (bool) {
    if (block.timestamp < expirationTime) {
        return false; // å°šæœªåˆ°æœŸ
    }
    return (block.timestamp - expirationTime) > 30 days;
}
```

---

## 7. æ£€æµ‹ä¸é¢„é˜²ç­–ç•¥

### 7.1 ä»£ç å®¡æŸ¥è¦ç‚¹

**é«˜é£é™©æ¨¡å¼è¯†åˆ«**ï¼š
- æœªç»æ£€æŸ¥çš„ç®—æœ¯è¿ç®—ï¼ˆç‰¹åˆ«æ˜¯ä¹˜æ³•å’Œå‡æ³•ï¼‰
- å¾ªç¯ä¸­çš„è®¡æ•°å™¨æ“ä½œ
- ç”¨æˆ·è¾“å…¥çš„æ•°å€¼è®¡ç®—
- ä¸ `type(uint256).max` ç›¸å…³çš„æ“ä½œ

### 7.2 æµ‹è¯•ç­–ç•¥

**è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹**ï¼š
```solidity
// é‡è¦çš„æµ‹è¯•åœºæ™¯
function testTransferEdgeCases() public {
    // æµ‹è¯• 0 è½¬è´¦
    token.transfer(alice, 0);
    
    // æµ‹è¯•æœ€å¤§é‡‘é¢è½¬è´¦
    token.transfer(alice, type(uint256).max);
    
    // æµ‹è¯•ä½™é¢ä¸è¶³çš„æƒ…å†µ
    vm.expectRevert();
    token.transfer(alice, 1e18); // å½“ä½™é¢ä¸º 0 æ—¶
}
```

### 7.3 é™æ€åˆ†æå·¥å…·

**æ¨èå·¥å…·**ï¼š
- **Slither**ï¼šè‡ªåŠ¨æ£€æµ‹ç®—æœ¯æ¼æ´
- **Mythril**ï¼šç¬¦å·æ‰§è¡Œå‘ç°æº¢å‡º
- **Securify**ï¼šæ¨¡å¼åŒ¹é…è¯†åˆ«é£é™©

---

## 8. æ€»ç»“ä¸æœ€ä½³å®è·µ

### 8.1 å…³é”®é˜²æŠ¤æªæ–½

1. **âœ… å‡çº§åˆ° Solidity â‰¥ 0.8.0**
   - åˆ©ç”¨å†…ç½®çš„ç®—æœ¯å®‰å…¨æ£€æŸ¥
   - åœ¨æ€§èƒ½å…³é”®å¤„æ˜ç¡®ä½¿ç”¨ `unchecked`

2. **âœ… ä¸¥æ ¼çš„è¾“å…¥éªŒè¯**
   - éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥çš„æ•°å€¼èŒƒå›´
   - å®æ–½åˆç†çš„ä¸Šä¸‹é™é™åˆ¶

3. **âœ… å…¨é¢çš„æµ‹è¯•è¦†ç›–**
   - æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆ0, 1, max, max-1ï¼‰
   - è¿›è¡Œæ¨¡ç³Šæµ‹è¯•å‘ç°æ„å¤–æƒ…å†µ

4. **âœ… ä½¿ç”¨å®¡è®¡è¿‡çš„æ•°å­¦åº“**
   - OpenZeppelin çš„ SafeMathï¼ˆæ—§ç‰ˆæœ¬ï¼‰
   - PRBMathï¼ˆä¸“é—¨é’ˆå¯¹å¤æ‚æ•°å­¦è¿ç®—ï¼‰

### 8.2 ç°ä»£å¼€å‘å»ºè®®

**å¯¹äºæ–°é¡¹ç›®**ï¼š
```solidity
// âœ… æ¨èï¼šä½¿ç”¨ Solidity 0.8.x å¹¶ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ unchecked
pragma solidity ^0.8.19;

contract ModernToken {
    function transfer(address to, uint256 amount) public {
        // ä¾èµ–ç¼–è¯‘å™¨çš„å†…ç½®æ£€æŸ¥
        balances[msg.sender] -= amount;
        balances[to] += amount;
    }
    
    function optimizedBatchOperation(uint256[] memory amounts) public {
        uint256 total;
        unchecked { // æ˜ç¡®æ ‡è¯†å®‰å…¨çš„ä¸æ£€æŸ¥å—
            for (uint256 i = 0; i < amounts.length; i++) {
                total += amounts[i];
            }
        }
        // ä¸»è¦é€»è¾‘ä»ç„¶äº«å—è‡ªåŠ¨ä¿æŠ¤
        balances[msg.sender] -= total;
    }
}
```

### 8.3 é—ç•™ç³»ç»Ÿç»´æŠ¤

**å¯¹äºæ—§åˆçº¦**ï¼š
- è€ƒè™‘å‡çº§åˆ°æ–° Solidity ç‰ˆæœ¬
- å¦‚æœæ— æ³•å‡çº§ï¼Œç¡®ä¿å…¨é¢ä½¿ç”¨ SafeMath
- è¿›è¡Œå½»åº•çš„å®‰å…¨å®¡è®¡å’Œæµ‹è¯•

æ•´æ•°æº¢å‡º/ä¸‹æº¢è™½ç„¶åœ¨æ–°ç‰ˆæœ¬ Solidity ä¸­å·²å¾—åˆ°åŸºæœ¬è§£å†³ï¼Œä½†ç†è§£è¿™äº›æ¼æ´å¯¹äºç»´æŠ¤é—ç•™ç³»ç»Ÿã€è¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ·±å…¥ç†è§£æ™ºèƒ½åˆçº¦å®‰å…¨åŸºç¡€ä»ç„¶è‡³å…³é‡è¦ã€‚