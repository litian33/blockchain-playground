
è¿™ä¸€ç¯‡æ˜¯æ•´ä¸ªâ€œçŸ¿å·¥å‡ºå—æµç¨‹â€ç³»åˆ—çš„æ”¶å®˜ç¯‡ï¼Œæ¶µç›–å¦‚ä¸‹é‡ç‚¹ï¼š

* **å¦‚ä½•ä»æ‰§è¡Œå®Œæˆçš„çŠ¶æ€ç”Ÿæˆæœ€ç»ˆåŒºå—ï¼ˆFinalizeï¼‰**
* **ä¸åŒå…±è¯†æœºåˆ¶å¦‚ä½•å¯¹åŒºå—è¿›è¡Œå°è£…ï¼ˆSealï¼‰**
* **åŒºå—åœ¨ç½‘ç»œä¸­å¦‚ä½•å¹¿æ’­ï¼ˆBlock Propagationï¼‰**
* **å…¶ä»–èŠ‚ç‚¹å¦‚ä½•å¤„ç†æ”¶åˆ°çš„æ–°åŒºå—ï¼ˆåŒæ­¥ä¸éªŒè¯ï¼‰**
* **å¸¸è§æ”»å‡»é¢ä¸ Geth çš„é˜²å¾¡æœºåˆ¶**

æœ¬ç¯‡é€‚ç”¨äº PoWã€PoAã€PoSï¼ˆEngine API/CL+ELï¼‰ä»¥åŠ L2 Rollup çš„æ‰§è¡Œå±‚ã€‚

---

# **ç¬¬å››ç¯‡ï¼šåŒºå—æ„é€ ã€å…±è¯†å°è£…ä¸å¹¿æ’­**

---

# ä¸€ã€åŒºå—æ•°æ®ç»“æ„å¤ç›˜

æœ€ç»ˆç”Ÿæˆçš„åŒºå—åŒ…å«ï¼š

```
Block {
    Header
    Body {
        Transactions[]
        Ommers[] (uncles)
        Withdrawals[] (EIP-4895)
        Deposits[] (L1â†’L2 rollup åœºæ™¯)
    }
    BlobBundle? (EIP-4844)
}
```

---

## ğŸ“Œ 1.1 Headerï¼ˆåŒºå—å¤´ï¼‰

Header æ˜¯åŒºå—æœ€é‡è¦çš„ç»“æ„ï¼ŒåŒ…å«æ‰§è¡Œç»“æœçš„â€œæ‘˜è¦â€ï¼š

| å­—æ®µ                           | å«ä¹‰                           |
| ---------------------------- | ---------------------------- |
| parentHash                   | ä¸Šä¸€å—                          |
| stateRoot                    | Merkle Patricia Trie çš„æ ¹ï¼ˆçŠ¶æ€æ ‘ï¼‰ |
| txRoot                       | äº¤æ˜“æ ‘æ ¹                         |
| receiptsRoot                 | æ”¶æ®æ ‘æ ¹                         |
| logsBloom                    | æ‰€æœ‰ receipts çš„ bloom          |
| gasUsed / gasLimit           | åŒºå— gas ä¿¡æ¯                    |
| baseFee                      | EIP-1559                     |
| blobGasUsed / excessBlobGas  | EIP-4844                     |
| timestamp                    | å‡ºå—æ—¶é—´                         |
| difficulty / mixHash / nonce | PoW ä¸“å±                       |
| extraData                    | PoA/Cliqueã€Engine API éƒ½ä¼šç”¨    |

**Header æ˜¯å…±è¯†ç­¾åæˆ– PoW è®¡ç®—çš„è¾“å…¥ã€‚**

---

## ğŸ“Œ 1.2 Bodyï¼ˆäº¤æ˜“ä¸å”å—ï¼‰

| ç»„ä»¶              | è¯´æ˜                       |
| --------------- | ------------------------ |
| Transactions    | æ­¤ block ä¸­æ‰€æœ‰è¢«æ‰§è¡Œçš„ tx       |
| Ommers (Uncles) | PoW ä¸­æ”¯æŒï¼ŒPoA/PoS ä¸­æ— ä½œç”¨     |
| BlobBundle      | å¯¹åº”æœ¬å— blob äº¤æ˜“ç”Ÿæˆçš„ KZG èšåˆæ•°æ® |
| Withdrawal      | PoS æç°ï¼ˆShapellaï¼‰         |

---

# äºŒã€Finalizeï¼šæ„é€ æœ€ç»ˆ Headerï¼ˆæ‰§è¡Œå®Œæˆåï¼‰

å½“æ‰€æœ‰äº¤æ˜“æ‰§è¡Œç»“æŸåï¼ŒMiner/Engine å±‚ä¼šè°ƒç”¨ï¼š

```
state.Finalize()
```

ç„¶åæ„é€  headerã€‚æµç¨‹å¦‚ä¸‹ï¼š

---

## ğŸ“Œ 2.1 å†™å…¥åŒºå—çš„ä¸‰æ£µâ€œTrie æ ‘â€æ ¹

| Trie             | å†…å®¹            |
| ---------------- | ------------- |
| **State Trie**   | æ‰€æœ‰è´¦æˆ·/å­˜å‚¨çš„æœ€æ–°çŠ¶æ€  |
| **Tx Trie**      | æœ¬å—æ‰€æœ‰äº¤æ˜“ï¼ˆæŒ‰æ‰§è¡Œé¡ºåºï¼‰ |
| **Receipt Trie** | æ¯ä¸ªäº¤æ˜“çš„æ‰§è¡Œç»“æœ     |

ä»£ç åœ¨ï¼š

```
core/block_validator.go
core/state/statedb.go
core/types/block.go
```

æœ€ç»ˆ header å¡«å……ï¼š

```go
header.Root = state.IntermediateRoot(true)
header.TxHash = types.DeriveSha(txs)
header.ReceiptHash = types.DeriveSha(receipts)
```

---

## ğŸ“Œ 2.2 Gas æ•°æ®æ›´æ–°

```go
header.GasUsed = cumulativeGas
header.BlobGasUsed = sum(blobGasUsed)
header.ExcessBlobGas = computeExcessBlobGas(...)
```

---

## ğŸ“Œ 2.3 EIP-1559 / 4844 å‚æ•°æ›´æ–°

* baseFee = nextBaseFee(parent, gasUsed)
* blobGasUsed å½±å“ excessBlobGasï¼ˆEIP-4844ï¼‰

---

## ğŸ“Œ 2.4 Log Bloom æ„å»º

ä» receipts ä¸­åˆå¹¶ bloomï¼š

```go
Bloom â† OR(receipt.bloom)
header.Bloom = Bloom
```

---

# ä¸‰ã€Sealï¼šæ‰§è¡Œå…±è¯†å±‚ç­¾å/è®¡ç®—ï¼ˆPoW / PoA / PoS ä¸ L2ï¼‰

Finalize å¾—åˆ°çš„ block **æ˜¯â€œæœªå°å°çš„ blockâ€**ï¼ˆunsealed blockï¼‰ã€‚
è¦æ„æˆä¸€ä¸ªçœŸæ­£èƒ½è¢«å¹¿æ’­çš„ blockï¼Œå¿…é¡»ç»è¿‡ **Seal()** æ­¥éª¤ã€‚

è¿™éƒ¨åˆ†ç”±ä¸åŒçš„å…±è¯†æ¨¡å—å®ç°ï¼š

---

# ğŸ›  3.1 PoWï¼šçœŸæ­£çš„æŒ–çŸ¿ï¼ˆç®— nonce ä¸ mixHashï¼‰

æµç¨‹ï¼š

1. å°† header çš„éƒ¨åˆ†å­—æ®µï¼ˆé™¤ nonce/mixï¼‰åºåˆ—åŒ– â†’ powHash
2. ä¸åœå°è¯• nonceï¼ˆè‹¥ use ethash â†’ DAG + Hashimoto ç®—æ³•ï¼‰
3. æ‰¾åˆ°æ»¡è¶³éš¾åº¦ç›®æ ‡ï¼ˆdifficultyï¼‰çš„ nonce/mix
4. å†™å› header

```
header.Nonce = solutionNonce
header.MixHash = solutionMixHash
```

---

# ğŸ›  3.2 PoA/Cliqueï¼šç­¾åå°è£…

Clique çš„ Seal é€»è¾‘ï¼š

1. æ„é€ ç”¨äºç­¾åçš„ header hashï¼ˆSealHashï¼‰
2. ä½¿ç”¨æœ¬åœ° signer ç§é’¥ç­¾å ECDSA
3. å°†ç­¾åæ”¾è¿› extraData å°¾éƒ¨

```
header.Extra = vanity + signerSignature
```

PoA ä¸éœ€è¦â€œæŒ–çŸ¿â€ï¼Œç›´æ¥ç­¾åã€‚

---

# ğŸ›  3.3 PoS/Engine APIï¼ˆç°ä¸»ç½‘ï¼‰ï¼šCL è´Ÿè´£åŒºå—æœ€ç»ˆåŒ–

ç°åœ¨ä¸»ç½‘ Ethereum ä½¿ç”¨ **CL (Beacon Chain) â†’ EL (Execution Layer)** åˆ†å±‚ç»“æ„ã€‚

Seal ä¸å†ç”± Geth è´Ÿè´£ï¼Œè€Œæ˜¯ï¼š

* Gethï¼ˆELï¼‰ç”Ÿæˆ **ExecutionPayload**
* å…±è¯†å±‚å®¢æˆ·ç«¯ï¼ˆCLï¼‰è°ƒç”¨ `engine_forkchoiceUpdated / engine_getPayload`
* CL æœ€ç»ˆå¯¹åŒºå—ç­¾å

EL æœ¬èº«ä¸ä¼šâ€œå°è£…â€ nonceï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿ difficultyã€‚

Seal çš„æ„ä¹‰å˜æˆï¼š

```
Block â†’ ExecutionPayload â†’ CL ç½²å â†’ æœ€ç»ˆæˆä¸ºçœŸå®åŒºå—
```

---

# ğŸ›  3.4 L2 Rollupï¼ˆOPã€Arbitrumã€ZKï¼‰åœºæ™¯

å¾ˆå¤š L2 å®Œå…¨ä¸éœ€è¦ Sealï¼š

* åŒºå—ä¸éœ€è¦ PoW æˆ– PoA
* L2 block åªéœ€è¦æ„é€  â†’ å†™å…¥æœ¬åœ°é“¾å­˜å‚¨å³å¯
* åœ¨ L1 ä¸Šæäº¤çš„æ‰æ˜¯â€œæœ€ç»ˆçŠ¶æ€â€

ä¾‹å¦‚ OP Stackï¼š

```
Finalize â†’ L2 block produced
â†’ Proposer æ‰“åŒ… OutputRoot â†’ L1 äº¤æ˜“
```

---

# å››ã€åŒºå—å¹¿æ’­ï¼ˆBlock Propagationï¼‰

å°è£…å¥½çš„åŒºå—ä¼šé€šè¿‡ P2P å¹¿æ’­ï¼Œæµç¨‹ï¼š

### **1ï¼‰å‘å¸ƒ block announcementï¼ˆNewBlockHashesï¼‰**

åªå¹¿æ’­ block hash å’Œéƒ¨åˆ† metadataï¼Œè®©é‚»å±…èŠ‚ç‚¹è‡ªè¡Œ Pullï¼š

```
eth.NewBlockHashes{hash, number}
```

---

### **2ï¼‰ç›´æ¥å¹¿æ’­ NewBlockï¼ˆå¸¦äº¤æ˜“ï¼‰**

å¯¹éƒ¨åˆ†å¯¹ç­‰èŠ‚ç‚¹ï¼ˆé¦–æ‰¹ï¼‰ç›´æ¥æ¨é€æ•´ä¸ªåŒºå—ã€‚

**ç­–ç•¥ï¼š**
Geth ä¼šé€‰æ‹©å°‘é‡èŠ‚ç‚¹ç›´æ¥å‘é€ blockï¼Œå…¶ä»–èŠ‚ç‚¹åªå‘é€ hashï¼ˆå‡è½»ç½‘ç»œå‹åŠ›ï¼‰ã€‚

---

### **3ï¼‰è¢«åŠ¨å“åº”èŠ‚ç‚¹æ‹‰å–ï¼ˆGetBlockHeaders / GetBlockBodiesï¼‰**

å½“å¯¹æ–¹èŠ‚ç‚¹æ”¶åˆ° block hashï¼š

```
â†’ request block header
â†’ request block body
â†’ request blob sidecar (EIP-4844)
```

---

# äº”ã€å…¶ä»–èŠ‚ç‚¹å¦‚ä½•å¤„ç†åŒºå—ï¼ˆå¿«é€ŸåŒæ­¥ & å®Œæ•´éªŒè¯ï¼‰

å½“ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°åŒºå—ï¼š

---

## ğŸ“Œ 5.1 å¿«é€Ÿä¸‹è½½èŠ‚ç‚¹ï¼ˆsnap/fast syncï¼‰

ä¸ä¼šæ‰§è¡Œæ‰€æœ‰äº¤æ˜“ï¼ŒåªéªŒè¯ï¼š

* Headerï¼ˆPoS/Pow/Poa ç­¾åã€mixï¼‰
* State rootï¼ˆä½¿ç”¨ state syncï¼‰
* Tx/Receipt rootsï¼ˆä¸ç”¨æœ¬åœ°æ‰§è¡Œï¼‰

è¿™æ˜¯ **ä¿¡ä»»ç½‘ç»œæä¾›çš„ state snapshot** çš„å˜ç§ã€‚

---

## ğŸ“Œ 5.2 å…¨èŠ‚ç‚¹

æµç¨‹ï¼š

1. éªŒè¯ headerï¼ˆSealã€MixHashã€ç­¾åã€timestampã€baseFeeï¼‰
2. æ‰§è¡Œæ‰€æœ‰äº¤æ˜“ï¼ˆä¸çŸ¿å·¥ç›¸åŒï¼‰
3. å¯¹æ¯”æ‰§è¡Œç»“æœï¼š

   * stateRoot æ˜¯å¦ä¸ header åŒ¹é…ï¼Ÿ
   * txRootã€receiptRoot æ˜¯å¦ä¸€è‡´ï¼Ÿ
4. å…¥é“¾å†™ç›˜

è‹¥ä»»ä½•ä¸ä¸€è‡´ â†’ block è¢«æ‹’ç»ã€‚

---

# å…­ã€å…¸å‹æ”»å‡»ä¸ Geth é˜²å¾¡æœºåˆ¶

### âœ” DoSï¼šå¤§é‡æ— æ•ˆäº¤æ˜“ â†’ block éªŒè¯æ‹–å»¶

**é˜²å¾¡ï¼š**

* TxPool å±‚è¿‡æ»¤
* Intrinsic gas æ£€æŸ¥
* nonce/ä½™é¢éªŒè¯

---

### âœ” è†¨èƒ€æ”»å‡»ï¼šå·¨å‹åŒºå—å¯¼è‡´èŠ‚ç‚¹å¡é¡¿

**é˜²å¾¡ï¼š**

* gasLimit åŠ¨æ€è°ƒèŠ‚
* blobGas é™åˆ¶ï¼ˆEIP-4844ï¼‰

---

### âœ” é‡æ”¾æ”»å‡»

**é˜²å¾¡ï¼š**

* chain idã€EIP-155
* nonce å•è°ƒè§„åˆ™

---

### âœ” åŒºå—åƒåœ¾å¹¿æ’­

**é˜²å¾¡ï¼š**

* BlockHash å…ˆè¡Œå¹¿æ’­ï¼ˆè½»é‡ï¼‰
* Body/Sidecar æŒ‰éœ€è·å–
* rate limit

---

### âœ” PoW epoch æ”»å‡»ï¼ˆDAGï¼‰

**é˜²å¾¡ï¼š**

* epoch cache
* fast-slice DAG

---

# æ€»ç»“ï¼š

| æ¨¡å—       | ä½œç”¨                                  |
| -------- | ----------------------------------- |
| Finalize | æ„é€ æœ€ç»ˆåŒºå—å¤´ï¼ˆä¸‰æ£µ trie + gas + bloomï¼‰      |
| Seal     | å…±è¯†å°è£…ï¼šPoW/PoA/PoS/L2                 |
| å¹¿æ’­       | NewBlockHashes â†’ éƒ¨åˆ† NewBlock â†’ æŒ‰éœ€è¡¥ä½“ |
| éªŒè¯       | å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œç»Ÿä¸€éªŒè¯è·¯å¾„                        |
| å®‰å…¨æ€§      | å¤šç§ DoSã€é˜²åƒåœ¾ã€é˜²ä¼ªåŒºå—æœºåˆ¶                   |

